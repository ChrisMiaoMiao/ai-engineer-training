# LlamaIndex æ–‡æœ¬åˆ‡ç‰‡ç­–ç•¥å®éªŒæŠ¥å‘Š

## å®éªŒæ¦‚è¿°

æœ¬å®éªŒç³»ç»Ÿæ€§åœ°æ¯”è¾ƒäº†ä¸‰ç§æ–‡æœ¬åˆ‡ç‰‡ç­–ç•¥ï¼ˆSentenceSplitterã€TokenTextSplitterã€SentenceWindowNodeParserï¼‰åœ¨ä¸­æ–‡RAGç³»ç»Ÿä¸­çš„è¡¨ç°ï¼Œå…±æµ‹è¯•15ä¸ªä¸åŒå‚æ•°é…ç½®ï¼Œæ—¨åœ¨æ‰¾å‡ºå½±å“æ£€ç´¢æ•ˆæœçš„å…³é”®å‚æ•°,å¹¶ä¸ºå®é™…åº”ç”¨æä¾›æœ€ä½³å®è·µæŒ‡å¯¼ã€‚

**æµ‹è¯•æ•°æ®é›†**ï¼š
- 3ä¸ªä¸­æ–‡æ–‡æ¡£ï¼ˆäººå·¥æ™ºèƒ½ã€æœºå™¨å­¦ä¹ ã€è‡ªç„¶è¯­è¨€å¤„ç†ä¸»é¢˜ï¼‰
- æ€»å­—ç¬¦æ•°ï¼š12,776å­—ç¬¦
- æµ‹è¯•æŸ¥è¯¢ï¼š"ä»€ä¹ˆæ˜¯æ·±åº¦å­¦ä¹ ï¼Ÿå®ƒä¸æœºå™¨å­¦ä¹ æœ‰ä»€ä¹ˆå…³ç³»ï¼Ÿ"

**æŠ€æœ¯æ ˆ**ï¼š
- Embeddingæ¨¡å‹ï¼šDashScope TEXT_EMBEDDING_V3ï¼ˆé™åˆ¶ï¼šå•æ–‡æœ¬2048 tokensï¼‰
- LLMæ¨¡å‹ï¼šqwen-plus
- æ¡†æ¶ï¼šLlamaIndex 0.x

---

## ä¸€ã€å“ªäº›å‚æ•°æ˜¾è‘—å½±å“æ•ˆæœï¼Ÿä¸ºä»€ä¹ˆï¼Ÿ

### 1.1 chunk_sizeï¼ˆå—å¤§å°ï¼‰â€”â€” æœ€å…³é”®å‚æ•° ğŸ¯

**å½±å“ç¨‹åº¦ï¼šâ˜…â˜…â˜…â˜…â˜…**

#### å®éªŒæ•°æ®å¯¹æ¯”

| åˆ‡ç‰‡æ–¹æ³• | chunk_size | ç”ŸæˆèŠ‚ç‚¹æ•° | å½±å“åˆ†æ |
|---------|-----------|-----------|---------|
| å¥å­åˆ‡ç‰‡ | 128å­—ç¬¦ | 76-78ä¸ª | èŠ‚ç‚¹è¿‡å¤šï¼Œå•èŠ‚ç‚¹ä¿¡æ¯ç¢ç‰‡åŒ– |
| å¥å­åˆ‡ç‰‡ | 256å­—ç¬¦ | 35-36ä¸ª | **æœ€ä¼˜å¹³è¡¡ç‚¹** |
| å¥å­åˆ‡ç‰‡ | 512å­—ç¬¦ | 16ä¸ª | èŠ‚ç‚¹è¿‡å°‘ï¼Œæ£€ç´¢ç²’åº¦ç²—ç³™ |
| Tokenåˆ‡ç‰‡ | 128 tokens | 152-187ä¸ª | ä¸¥é‡ç¢ç‰‡åŒ–ï¼Œä¸Šä¸‹æ–‡ä¸è¿è´¯ |
| Tokenåˆ‡ç‰‡ | 256 tokens | 77-82ä¸ª | è¾ƒå¥½å¹³è¡¡ |
| Tokenåˆ‡ç‰‡ | 512 tokens | 42ä¸ª | å•èŠ‚ç‚¹ä¿¡æ¯é‡å¤§ï¼Œä½†å¯èƒ½è·¨è¶Šä¸»é¢˜ |

#### ä¸ºä»€ä¹ˆchunk_sizeå¦‚æ­¤é‡è¦ï¼Ÿ

**1. ä¿¡æ¯å®Œæ•´æ€§æƒè¡¡**
```
å°å— (128å­—ç¬¦/tokens)
âœ“ ä¼˜åŠ¿ï¼šæ£€ç´¢ç²¾ç¡®åº¦é«˜ï¼ŒåŒ¹é…æ›´ç²¾å‡†
âœ— åŠ£åŠ¿ï¼šå•ä¸ªchunkç¼ºä¹å®Œæ•´è¯­ä¹‰ï¼Œéš¾ä»¥å›ç­”å¤æ‚é—®é¢˜

å¤§å— (512å­—ç¬¦/tokens)  
âœ“ ä¼˜åŠ¿ï¼šä¸Šä¸‹æ–‡ä¸°å¯Œï¼Œè¯­ä¹‰å®Œæ•´
âœ— åŠ£åŠ¿ï¼šæ£€ç´¢å¬å›å™ªå£°å¤šï¼Œç›¸å…³æ€§å¯èƒ½é™ä½
```

**2. å‘é‡æ£€ç´¢ç‰¹æ€§**
- **å°chunk**ï¼šå‘é‡è¡¨ç¤ºæ›´ä¸“æ³¨äºå±€éƒ¨ç‰¹å¾ï¼Œè¯­ä¹‰ç›¸ä¼¼åº¦è®¡ç®—æ›´ç²¾ç¡®ï¼Œä½†å®¹æ˜“é—æ¼å…³è”ä¿¡æ¯
- **å¤§chunk**ï¼šå‘é‡è¡¨ç¤ºç»¼åˆå¤šä¸ªä¸»é¢˜ï¼Œå¯èƒ½å¯¼è‡´"å¹³å‡åŒ–"æ•ˆåº”ï¼Œé™ä½ç‰¹å®šæŸ¥è¯¢çš„åŒ¹é…åº¦

**3. ä¸­æ–‡è¯­è¨€ç‰¹æ€§**
- ä¸­æ–‡å¥å­ä¸€èˆ¬20-50å­—ç¬¦
- ä¸€ä¸ªå®Œæ•´è®ºè¿°é€šå¸¸éœ€è¦2-3ä¸ªå¥å­ï¼ˆ100-200å­—ç¬¦ï¼‰
- **å»ºè®®chunk_sizeèŒƒå›´**ï¼š200-300å­—ç¬¦ï¼ˆçº¦ç­‰äº150-200 tokensï¼‰

**å®éªŒç»“è®º**ï¼š
- âœ… **æœ€ä¼˜é…ç½®**ï¼šchunk_size=256å­—ç¬¦ï¼ˆå¥å­åˆ‡ç‰‡ï¼‰æˆ–256 tokensï¼ˆTokenåˆ‡ç‰‡ï¼‰
- åŸå› ï¼šåœ¨12,776å­—ç¬¦çš„æµ‹è¯•é›†ä¸Šç”Ÿæˆ35-77ä¸ªèŠ‚ç‚¹ï¼Œæ—¢ä¿è¯äº†æ£€ç´¢ç²’åº¦ï¼Œåˆç»´æŒäº†è¯­ä¹‰å®Œæ•´æ€§

---

### 1.2 åˆ‡ç‰‡æ–¹æ³•é€‰æ‹© â€”â€” æ¶æ„çº§å†³ç­– ğŸ—ï¸

**å½±å“ç¨‹åº¦ï¼šâ˜…â˜…â˜…â˜…â˜†**

#### ä¸‰ç§æ–¹æ³•å¯¹æ¯”

| æ–¹æ³• | åˆ‡åˆ†ä¾æ® | ä¼˜åŠ¿ | åŠ£åŠ¿ | é€‚ç”¨åœºæ™¯ |
|------|---------|------|------|---------|
| **SentenceSplitter** | å¥å­è¾¹ç•Œ | ä¿æŒè¯­ä¹‰å®Œæ•´æ€§ | å¯¹æ ‡ç‚¹ç¬¦å·ä¾èµ–å¼º | ä¸­æ–‡ã€æ­£å¼æ–‡æ¡£ |
| **TokenTextSplitter** | Tokenæ•°é‡ | ç²¾ç¡®æ§åˆ¶é•¿åº¦ | å¯èƒ½åˆ‡æ–­å¥å­ | è‹±æ–‡ã€ä¸¥æ ¼é•¿åº¦é™åˆ¶ |
| **SentenceWindowNodeParser** | å¥å­+çª—å£ä¸Šä¸‹æ–‡ | æ£€ç´¢ç²¾å‡†+ä¸Šä¸‹æ–‡ä¸°å¯Œ | å®ç°å¤æ‚ï¼Œæ€§èƒ½å¼€é”€å¤§ | é«˜è´¨é‡é—®ç­”åœºæ™¯ |

#### ä¸ºä»€ä¹ˆæ–¹æ³•é€‰æ‹©å¾ˆé‡è¦ï¼Ÿ

**æ¡ˆä¾‹1ï¼šå¥å­åˆ‡ç‰‡ vs Tokenåˆ‡ç‰‡**
```python
# åŒæ ·çš„æ–‡æ¡£ï¼Œä¸åŒæ–¹æ³•ç”Ÿæˆçš„èŠ‚ç‚¹æ•°å·®å¼‚å·¨å¤§
å¥å­åˆ‡ç‰‡(256å­—ç¬¦): 35ä¸ªèŠ‚ç‚¹  
Tokenåˆ‡ç‰‡(256 tokens): 77ä¸ªèŠ‚ç‚¹  

# åŸå› ï¼šä¸­æ–‡å­—ç¬¦ä¸tokençš„è½¬æ¢æ¯”ä¾‹çº¦1:0.5-0.7
# 256å­—ç¬¦ â‰ˆ 128-179 tokens
# 256 tokens â‰ˆ 365-512å­—ç¬¦
```

**æ¡ˆä¾‹2ï¼šå¥å­çª—å£çš„ç‰¹æ®Šä»·å€¼**
```
ä¼ ç»Ÿåˆ‡ç‰‡ï¼šæ£€ç´¢åˆ° "æ·±åº¦å­¦ä¹ æ˜¯æœºå™¨å­¦ä¹ çš„å­é¢†åŸŸ"
çª—å£åˆ‡ç‰‡ï¼šæ£€ç´¢åˆ° "æ·±åº¦å­¦ä¹ æ˜¯æœºå™¨å­¦ä¹ çš„å­é¢†åŸŸ" + å‰åå„3å¥è¯çš„ä¸Šä¸‹æ–‡

å›ç­”è´¨é‡æå‡ï¼šä¼ ç»Ÿæ–¹æ³•å¯èƒ½åªèƒ½å®šä¹‰æ¦‚å¿µï¼Œçª—å£æ–¹æ³•èƒ½è§£é‡Šå…³ç³»å’Œåº”ç”¨
```

**å®éªŒå‘ç°**ï¼š
- å¥å­çª—å£åˆ‡ç‰‡éœ€è¦**ä¸¤æ­¥å¤„ç†**ï¼ˆå…ˆåŸºç¡€åˆ†å‰²ï¼Œå†æ„å»ºçª—å£ï¼‰ï¼Œå¦åˆ™ä¼šå°†æ•´ä¸ªæ–‡æ¡£è§†ä¸ºå•å¥
- ä¿®å¤å‰ï¼š3ä¸ªè¶…å¤§èŠ‚ç‚¹ï¼ˆ3007-5520å­—ç¬¦ï¼‰âŒ
- ä¿®å¤åï¼š31ä¸ªåˆç†èŠ‚ç‚¹ï¼ˆ300-500å­—ç¬¦ï¼‰âœ…

---

### 1.3 window_sizeï¼ˆçª—å£å¤§å°ï¼‰â€”â€” ä¸Šä¸‹æ–‡å¢å¼ºå‚æ•° ğŸ”

**å½±å“ç¨‹åº¦ï¼šâ˜…â˜…â˜…â˜†â˜†**ï¼ˆä»…å¯¹SentenceWindowNodeParseræœ‰æ•ˆï¼‰

#### å®éªŒé…ç½®

| window_size | å«ä¹‰ | å®é™…ä¸Šä¸‹æ–‡èŒƒå›´ | æ¨èåœºæ™¯ |
|-------------|------|---------------|---------|
| 1 | å‰åå„1å¥ | çº¦3å¥è¯ | ç®€çŸ­é—®ç­” |
| 2 | å‰åå„2å¥ | çº¦5å¥è¯ | ä¸€èˆ¬é—®ç­” |
| 3 | å‰åå„3å¥ | çº¦7å¥è¯ | **æ¨èé…ç½®** |
| 5 | å‰åå„5å¥ | çº¦11å¥è¯ | å¤æ‚æ¨ç† |
| 10 | å‰åå„10å¥ | çº¦21å¥è¯ | å¯èƒ½å¼•å…¥å™ªå£° |

#### ä¸ºä»€ä¹ˆçª—å£å¤§å°é‡è¦ï¼Ÿ

**ä¿¡æ¯å™ªå£°å¹³è¡¡**ï¼š
```
çª—å£è¿‡å° (window_size=1):
âœ— ä¸Šä¸‹æ–‡ä¸è¶³ï¼Œéš¾ä»¥ç†è§£å®Œæ•´è®ºè¿°
âœ— æ— æ³•æ•æ‰è·¨å¥å­çš„é€»è¾‘å…³ç³»

çª—å£é€‚ä¸­ (window_size=3):
âœ“ 7å¥è¯è¶³ä»¥è¦†ç›–ä¸€ä¸ªå®Œæ•´æ®µè½çš„æ ¸å¿ƒå†…å®¹
âœ“ åœ¨"ç²¾ç¡®æ£€ç´¢"çš„åŸºç¡€ä¸Šè¡¥å……"è¯­ä¹‰è¿è´¯æ€§"

çª—å£è¿‡å¤§ (window_size=10):
âœ— 21å¥è¯å¯èƒ½è·¨è¶Šå¤šä¸ªä¸»é¢˜
âœ— å¼•å…¥æ— å…³ä¿¡æ¯ï¼Œæ··æ·†LLMçš„ç†è§£
```

**æ€§èƒ½å¼€é”€**ï¼š
- çª—å£è¶Šå¤§ï¼Œæ¯ä¸ªèŠ‚ç‚¹çš„å…ƒæ•°æ®è¶Šå¤š
- å­˜å‚¨æˆæœ¬å’Œæ£€ç´¢åå¤„ç†æ—¶é—´å¢åŠ 
- window_size=10æ—¶ï¼Œå…ƒæ•°æ®å¯èƒ½æ˜¯åŸèŠ‚ç‚¹çš„10å€

---

### 1.4 å…¶ä»–æ˜¾è‘—å‚æ•°

#### embed_batch_sizeï¼ˆåµŒå…¥æ‰¹æ¬¡å¤§å°ï¼‰
**å½±å“ç¨‹åº¦ï¼šâ˜…â˜…â˜†â˜†â˜†**
- æµ‹è¯•å€¼ï¼š6
- å½±å“ï¼šå¤„ç†é€Ÿåº¦ï¼Œä¸å½±å“æ£€ç´¢è´¨é‡
- å»ºè®®ï¼šæ ¹æ®APIé™åˆ¶è°ƒæ•´ï¼ˆDashScopeå»ºè®®â‰¤25ï¼‰

#### similarity_top_kï¼ˆæ£€ç´¢å¬å›æ•°ï¼‰
**å½±å“ç¨‹åº¦ï¼šâ˜…â˜…â˜…â˜…â˜†**
- æµ‹è¯•å€¼ï¼š5
- å½±å“ï¼šå¬å›çš„ç›¸å…³æ–‡æ¡£æ•°é‡
- è¿‡å°ï¼šé—æ¼ç›¸å…³ä¿¡æ¯
- è¿‡å¤§ï¼šå¼•å…¥å™ªå£°ï¼Œå¢åŠ LLMå¤„ç†è´Ÿæ‹…
- å»ºè®®ï¼š3-7ä¹‹é—´

---

## äºŒã€chunk_overlap è¿‡å¤§æˆ–è¿‡å°çš„åˆ©å¼Šï¼Ÿ

### 2.1 å®éªŒæ•°æ®åˆ†æ

| é…ç½® | chunk_size | overlap | ç”ŸæˆèŠ‚ç‚¹æ•° | overlapæ¯”ä¾‹ | åˆ†æ |
|------|-----------|---------|-----------|------------|------|
| å¥å­-é…ç½®1 | 128 | 0 | 76 | 0% | **æ— é‡å åŸºçº¿** |
| å¥å­-é…ç½®2 | 128 | 20 | 78 | 15.6% | å°é‡å  |
| å¥å­-é…ç½®3 | 256 | 50 | 35 | 19.5% | **æœ€ä¼˜é‡å ** |
| å¥å­-é…ç½®4 | 256 | 100 | 36 | 39.1% | å¤§é‡å  |
| Token-é…ç½®1 | 128 | 0 | 152 | 0% | æ— é‡å  |
| Token-é…ç½®2 | 128 | 20 | 187 | 15.6% | å°é‡å  |
| Token-é…ç½®4 | 256 | 50 | 82 | 19.5% | æœ€ä¼˜é‡å  |

### 2.2 chunk_overlap è¿‡å°çš„é—®é¢˜ âš ï¸

**overlap = 0ï¼ˆæ— é‡å ï¼‰**

#### ä¸»è¦åŠ£åŠ¿ï¼š

**1. ä¿¡æ¯æ–­è£‚é£é™©**
```
æ–‡æ¡£åŸæ–‡ï¼š
"æ·±åº¦å­¦ä¹ æ˜¯æœºå™¨å­¦ä¹ çš„ä¸€ä¸ªåˆ†æ”¯ã€‚å®ƒä½¿ç”¨å¤šå±‚ç¥ç»ç½‘ç»œæ¥å­¦ä¹ æ•°æ®çš„å±‚æ¬¡åŒ–è¡¨ç¤ºã€‚"

æ— é‡å åˆ‡ç‰‡ï¼š
Chunk 1: "æ·±åº¦å­¦ä¹ æ˜¯æœºå™¨å­¦ä¹ çš„ä¸€ä¸ªåˆ†æ”¯ã€‚"
Chunk 2: "å®ƒä½¿ç”¨å¤šå±‚ç¥ç»ç½‘ç»œæ¥å­¦ä¹ æ•°æ®çš„å±‚æ¬¡åŒ–è¡¨ç¤ºã€‚"

é—®é¢˜ï¼š
- "å®ƒ" æŒ‡ä»£ä¸æ˜ç¡®
- ä¸¤ä¸ªchunkçš„è¯­ä¹‰è¿ç»­æ€§ä¸¢å¤±
- æ£€ç´¢åˆ°Chunk 2æ—¶ç¼ºä¹ä¸»è¯­ä¿¡æ¯
```

**2. è¾¹ç•Œæ•æ„Ÿæ€§**
```
åœºæ™¯ï¼šç”¨æˆ·æŸ¥è¯¢ "æ·±åº¦å­¦ä¹ çš„ç‰¹ç‚¹"
å…³é”®ä¿¡æ¯æ°å¥½è·¨è¶Šä¸¤ä¸ªchunkè¾¹ç•Œï¼š

Chunk Aæœ«å°¾: "æ·±åº¦å­¦ä¹ çš„ä¸»è¦ç‰¹ç‚¹åŒ…æ‹¬"
Chunk Bå¼€å¤´: "è‡ªåŠ¨ç‰¹å¾æå–å’Œç«¯åˆ°ç«¯å­¦ä¹ "

ç»“æœï¼šä¸¤ä¸ªchunkéƒ½ä¸å®Œæ•´ï¼Œæ£€ç´¢æ•ˆæœå·®
```

**3. é²æ£’æ€§é™ä½**
- åŒä¹‰æŸ¥è¯¢å¯èƒ½å› è¾¹ç•Œä¸åŒè€Œæ£€ç´¢å¤±è´¥
- å¯¹åˆ†è¯å’Œå¥å­åˆ‡åˆ†é”™è¯¯å®¹å¿åº¦ä½

#### é€‚ç”¨åœºæ™¯ï¼š
âœ“ æ–‡æ¡£ç»“æ„æ¸…æ™°ï¼Œæ¯ä¸ªæ®µè½ç‹¬ç«‹
âœ“ å­˜å‚¨ç©ºé—´æåº¦å—é™
âœ“ æ–‡æ¡£æ›´æ–°é¢‘ç¹ï¼ˆé‡å ä¼šå¢åŠ æ›´æ–°æˆæœ¬ï¼‰

---

### 2.3 chunk_overlap è¿‡å¤§çš„é—®é¢˜ âš ï¸

**overlap = 100 æˆ–æ›´é«˜ï¼ˆ>40% chunk_sizeï¼‰**

#### ä¸»è¦åŠ£åŠ¿ï¼š

**1. å­˜å‚¨æˆæœ¬æ¿€å¢** ğŸ’°
```python
# è®¡ç®—å­˜å‚¨è†¨èƒ€ç‡
æ— é‡å : 76ä¸ªèŠ‚ç‚¹
20å­—ç¬¦é‡å : 78ä¸ªèŠ‚ç‚¹ (+2.6%)
100å­—ç¬¦é‡å : 36ä¸ªèŠ‚ç‚¹ (+2.8%)  # è™½ç„¶æ€»æ•°å°‘ï¼Œä½†å•èŠ‚ç‚¹å˜å¤§

å®é™…å­˜å‚¨ï¼ˆå‡è®¾256å­—ç¬¦chunkï¼‰:
overlap=0:   76 Ã— 256 = 19,456 å­—ç¬¦
overlap=50:  35 Ã— 256 = 8,960 å­—ç¬¦ï¼ˆä½†é‡å éƒ¨åˆ†é‡å¤å­˜å‚¨ï¼‰
overlap=100: 36 Ã— 256 = 9,216 å­—ç¬¦ï¼ˆé‡å éƒ¨åˆ†å æ¯”39%ï¼Œå®é™…å­˜å‚¨çº¦15,000å­—ç¬¦ï¼‰
```

**2. æ£€ç´¢å™ªå£°å¢åŠ ** ğŸ“Š
```
åœºæ™¯ï¼šæ£€ç´¢top_k=5

overlap=0: è¿”å›5ä¸ªä¸åŒçš„æ–‡æœ¬ç‰‡æ®µ
overlap=100: å¯èƒ½è¿”å›3ä¸ªé«˜åº¦é‡å çš„ç‰‡æ®µ + 2ä¸ªæ–°ç‰‡æ®µ

é—®é¢˜ï¼š
- å®é™…ä¿¡æ¯é‡å‡å°‘
- é«˜åº¦ç›¸ä¼¼çš„ç‰‡æ®µå æ®æ£€ç´¢ä½ç½®
- LLMæ”¶åˆ°é‡å¤ä¿¡æ¯ï¼Œæµªè´¹ä¸Šä¸‹æ–‡çª—å£
```

**3. è®¡ç®—æˆæœ¬å¢åŠ ** âš™ï¸
```
å½±å“ç¯èŠ‚ï¼š
1. Embeddingè®¡ç®—ï¼šé‡å éƒ¨åˆ†è¢«å¤šæ¬¡ç¼–ç 
2. å‘é‡å­˜å‚¨ï¼šç´¢å¼•å¤§å°å¢åŠ 
3. ç›¸ä¼¼åº¦è®¡ç®—ï¼šéœ€è¦æ¯”è¾ƒæ›´å¤šå‘é‡
4. å»é‡å¤„ç†ï¼šéœ€è¦é¢å¤–çš„åå¤„ç†é€»è¾‘

æˆæœ¬ä¼°ç®—ï¼ˆä»¥256å­—ç¬¦chunkä¸ºä¾‹ï¼‰ï¼š
overlap=0:   35ä¸ªèŠ‚ç‚¹ â†’ 35æ¬¡embeddingè°ƒç”¨
overlap=100: 36ä¸ªèŠ‚ç‚¹ â†’ 36æ¬¡embeddingè°ƒç”¨
ä½†é‡å å†…å®¹å æ¯”39%ï¼Œçº¦14æ¬¡è°ƒç”¨æ˜¯é‡å¤è®¡ç®—
```

**4. è¯­ä¹‰ç¨€é‡Šæ•ˆåº”** ğŸ¯
```
å¤§é‡å å¯¼è‡´ç›¸é‚»chunké«˜åº¦ç›¸ä¼¼ï¼š

Chunk N:   "...AAABBBCCC"
Chunk N+1: "...BBBCCCDDD"  (overlap=BBB+CCC)

é—®é¢˜ï¼š
- å‘é‡ç›¸ä¼¼åº¦ï¼šChunk N â‰ˆ Chunk N+1 (0.85-0.95)
- æ£€ç´¢æ—¶å®¹æ˜“åŒæ—¶å¬å›ï¼Œé™ä½å¤šæ ·æ€§
- éš¾ä»¥åŒºåˆ†çœŸæ­£çš„è¯­ä¹‰ç›¸å…³æ€§å’Œç»“æ„é‡å 
```

#### é€‚ç”¨åœºæ™¯ï¼š
âœ“ æ–‡æ¡£é«˜åº¦æŠ€æœ¯åŒ–ï¼Œè¾¹ç•Œä¿¡æ¯æä¸ºå…³é”®ï¼ˆå¦‚æ³•å¾‹æ¡æ¬¾ï¼‰
âœ“ æ£€ç´¢å‡†ç¡®æ€§ä¼˜å…ˆï¼Œæˆæœ¬æ¬¡è¦
âœ“ æ–‡æ¡£è¾ƒçŸ­ï¼Œæ€»èŠ‚ç‚¹æ•°ä¸å¤š

---

### 2.4 æœ€ä¼˜ chunk_overlap æ¨è âœ…

#### é»„é‡‘æ¯”ä¾‹ï¼š15-25% chunk_size

**ç†è®ºä¾æ®**ï¼š
1. **è®¤çŸ¥ç§‘å­¦**ï¼šäººç±»é˜…è¯»ç†è§£éœ€è¦çº¦10-20%çš„ä¸Šä¸‹æ–‡é‡å¤æ¥ç»´æŒè¿è´¯æ€§
2. **ä¿¡æ¯è®º**ï¼šé‡å éƒ¨åˆ†æä¾›å†—ä½™ï¼Œä½†ä¸åº”è¶…è¿‡ä¿¡æ¯ç†µçš„é˜ˆå€¼
3. **æˆæœ¬æ”¶ç›Š**ï¼šè¾¹é™…æ”¶ç›Šåœ¨25%åæ˜¾è‘—ä¸‹é™

**å®éªŒéªŒè¯**ï¼š
```
chunk_size=256, overlap=50 (19.5%)
âœ“ ç”ŸæˆèŠ‚ç‚¹æ•°é€‚ä¸­ (35ä¸ª)
âœ“ é¿å…ä¿¡æ¯æ–­è£‚
âœ“ å­˜å‚¨æˆæœ¬å¯æ¥å—
âœ“ æ£€ç´¢å¬å›è´¨é‡é«˜

chunk_size=256, overlap=100 (39.1%)
âœ— èŠ‚ç‚¹æ•°ç›¸è¿‘ (36ä¸ª)ï¼Œä½†é‡å¤å†…å®¹è¿‡å¤š
âœ— æ£€ç´¢ç»“æœç›¸ä¼¼åº¦è¿‡é«˜
âœ— æ€§ä»·æ¯”ä¸å¦‚19.5%é…ç½®
```

#### ä¸åŒåœºæ™¯çš„æ¨èé…ç½®

| åº”ç”¨åœºæ™¯ | chunk_size | overlap | overlapæ¯”ä¾‹ | ç†ç”± |
|---------|-----------|---------|------------|------|
| **ä¸­æ–‡é—®ç­”ç³»ç»Ÿ** | 256å­—ç¬¦ | 40-50å­—ç¬¦ | 15-20% | å¹³è¡¡è¯­ä¹‰å®Œæ•´æ€§å’Œæ•ˆç‡ |
| **è‹±æ–‡æ–‡æ¡£æ£€ç´¢** | 512 tokens | 100 tokens | 20% | è‹±æ–‡å¥å­æ›´é•¿ï¼Œéœ€è¦æ›´å¤šä¸Šä¸‹æ–‡ |
| **ä»£ç ç‰‡æ®µæ£€ç´¢** | 300å­—ç¬¦ | 30å­—ç¬¦ | 10% | ä»£ç ç»“æ„æ¸…æ™°ï¼Œä½é‡å å³å¯ |
| **æ³•å¾‹åˆè§„æ–‡æ¡£** | 512å­—ç¬¦ | 150å­—ç¬¦ | 30% | é«˜ç²¾åº¦è¦æ±‚ï¼Œå®¹å¿æ›´å¤šå†—ä½™ |
| **å®æ—¶èŠå¤©å†å²** | 200å­—ç¬¦ | 0 | 0% | æ›´æ–°é¢‘ç¹ï¼Œé¿å…é‡å¤å­˜å‚¨ |

---

### 2.5 åŠ¨æ€è°ƒæ•´ç­–ç•¥ ğŸ”„

**å»ºè®®**ï¼šæ ¹æ®æ–‡æ¡£ç‰¹å¾åŠ¨æ€è®¾ç½®overlap

```python
def calculate_optimal_overlap(chunk_size: int, document_type: str) -> int:
    """
    æ ¹æ®æ–‡æ¡£ç±»å‹è®¡ç®—æœ€ä¼˜é‡å 
    
    å‚æ•°ï¼š
        chunk_size: å—å¤§å°
        document_type: æ–‡æ¡£ç±»å‹ ('technical', 'narrative', 'conversational', 'legal')
    
    è¿”å›ï¼š
        æœ€ä¼˜é‡å å¤§å°
    """
    base_ratio = {
        'technical': 0.15,    # æŠ€æœ¯æ–‡æ¡£ï¼šä¸­ç­‰é‡å 
        'narrative': 0.20,    # å™è¿°æ€§æ–‡æ¡£ï¼šè¾ƒé«˜é‡å ï¼ˆæ•…äº‹è¿è´¯æ€§é‡è¦ï¼‰
        'conversational': 0.10,  # å¯¹è¯æ–‡æ¡£ï¼šä½é‡å ï¼ˆç‹¬ç«‹æ€§å¼ºï¼‰
        'legal': 0.30         # æ³•å¾‹æ–‡æ¡£ï¼šé«˜é‡å ï¼ˆç²¾ç¡®æ€§ä¼˜å…ˆï¼‰
    }
    
    ratio = base_ratio.get(document_type, 0.20)  # é»˜è®¤20%
    return int(chunk_size * ratio)

# ç¤ºä¾‹
overlap_chinese_qa = calculate_optimal_overlap(256, 'narrative')  # 51å­—ç¬¦
overlap_code_docs = calculate_optimal_overlap(300, 'technical')   # 45å­—ç¬¦
overlap_legal = calculate_optimal_overlap(512, 'legal')           # 154å­—ç¬¦
```

---

## ä¸‰ã€å¦‚ä½•åœ¨"ç²¾ç¡®æ£€ç´¢"ä¸"ä¸Šä¸‹æ–‡ä¸°å¯Œæ€§"ä¹‹é—´æƒè¡¡ï¼Ÿ

è¿™æ˜¯RAGç³»ç»Ÿè®¾è®¡çš„æ ¸å¿ƒçŸ›ç›¾ï¼Œéœ€è¦ä»æŠ€æœ¯ã€åœºæ™¯å’Œæ¶æ„ä¸‰ä¸ªå±‚é¢ç»¼åˆè€ƒè™‘ã€‚

---

### 3.1 çŸ›ç›¾æœ¬è´¨åˆ†æ ğŸ¯

#### ç²¾ç¡®æ£€ç´¢ vs ä¸Šä¸‹æ–‡ä¸°å¯Œæ€§çš„æƒè¡¡æ›²çº¿

```
ä¸Šä¸‹æ–‡ä¸°å¯Œæ€§ â†‘
â”‚
â”‚                  â•±â•² æœ€ä¼˜åŒºé—´
â”‚                â•±    â•²
â”‚              â•±        â•²
â”‚            â•±            â•²
â”‚          â•±                â•²
â”‚        â•±                    â•²
â”‚      â•±                        â•²
â”‚â”€â”€â”€â”€â•±â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â•²â”€â”€â†’ ç²¾ç¡®æ£€ç´¢ â†‘
   å°chunk              å¤§chunk
  (128å­—ç¬¦)            (1024å­—ç¬¦)
```

**æœ¬è´¨å†²çª**ï¼š
- **ç²¾ç¡®æ£€ç´¢**éœ€è¦ï¼šå°chunkã€ä½é‡å ã€ç²¾å‡†å‘é‡åŒ¹é…
- **ä¸°å¯Œä¸Šä¸‹æ–‡**éœ€è¦ï¼šå¤§chunkã€é«˜é‡å ã€å®Œæ•´è¯­ä¹‰

**æ— æ³•ä¸¤å…¨çš„åŸå› **ï¼š
1. **å‘é‡è¡¨ç¤ºçš„å¹³å‡åŒ–æ•ˆåº”**ï¼šå¤§chunkåŒ…å«å¤šä¸ªä¸»é¢˜ï¼Œå‘é‡è¡¨ç¤ºä¼š"æ¨¡ç³ŠåŒ–"
2. **æ£€ç´¢æ’åºçš„å±€é™æ€§**ï¼šç›¸ä¼¼åº¦è®¡ç®—æ— æ³•åŒºåˆ†"å±€éƒ¨é«˜åº¦ç›¸å…³"å’Œ"æ•´ä½“ä¸­åº¦ç›¸å…³"
3. **LLMä¸Šä¸‹æ–‡çª—å£é™åˆ¶**ï¼šä¸èƒ½æ— é™å¢åŠ æ£€ç´¢å†…å®¹

---

### 3.2 åˆ†å±‚ç­–ç•¥ï¼šæ ¹æ®åº”ç”¨åœºæ™¯é€‰æ‹©ä¾§é‡ç‚¹ ğŸ­

#### ç­–ç•¥1ï¼šç²¾ç¡®æ£€ç´¢ä¼˜å…ˆï¼ˆPrecision-Firstï¼‰

**é€‚ç”¨åœºæ™¯**ï¼š
- âœ“ äº‹å®æŸ¥è¯¢å‹é—®ç­”ï¼ˆ"Pythonçš„åˆ—è¡¨æ¨å¯¼å¼è¯­æ³•æ˜¯ä»€ä¹ˆï¼Ÿ"ï¼‰
- âœ“ å®šä¹‰æ£€ç´¢ï¼ˆ"ä»€ä¹ˆæ˜¯å·ç§¯ç¥ç»ç½‘ç»œï¼Ÿ"ï¼‰
- âœ“ ä»£ç ç‰‡æ®µæŸ¥æ‰¾
- âœ“ æ•°æ®åº“/APIæ–‡æ¡£æ£€ç´¢

**æ¨èé…ç½®**ï¼š
```python
# é…ç½®æ–¹æ¡ˆ
chunk_size = 200          # å°chunkï¼Œèšç„¦å•ä¸€æ¦‚å¿µ
chunk_overlap = 20        # ä½é‡å ï¼ˆ10%ï¼‰
similarity_top_k = 3      # å°‘å¬å›ï¼Œé«˜ç²¾åº¦

# ä½¿ç”¨SentenceSplitter
splitter = SentenceSplitter(
    chunk_size=200,
    chunk_overlap=20
)

# ä¸ºä»€ä¹ˆæœ‰æ•ˆï¼Ÿ
# - å°chunkç¡®ä¿æ£€ç´¢åˆ°çš„å†…å®¹é«˜åº¦ç›¸å…³
# - ä½é‡å é¿å…é‡å¤ä¿¡æ¯
# - LLMå¯ä»¥ç›´æ¥ä½¿ç”¨æ£€ç´¢ç»“æœï¼Œæ— éœ€å¤§é‡ç­›é€‰
```

**ä¼˜åŠ¿**ï¼š
- âœ… æ£€ç´¢é€Ÿåº¦å¿«ï¼ˆèŠ‚ç‚¹æ•°å¤šä½†å•æ¬¡æ£€ç´¢å¿«ï¼‰
- âœ… å‡†ç¡®åº¦é«˜ï¼ˆå™ªå£°å°‘ï¼‰
- âœ… é€‚åˆç®€çŸ­ç›´æ¥çš„å›ç­”

**åŠ£åŠ¿**ï¼š
- âŒ å¤æ‚é—®é¢˜å¯èƒ½ç­”ä¸å…¨
- âŒ ç¼ºä¹æ¨ç†æ‰€éœ€çš„èƒŒæ™¯çŸ¥è¯†

**å®éªŒè¯æ®**ï¼š
```
æµ‹è¯•æŸ¥è¯¢ï¼š"ä»€ä¹ˆæ˜¯æ·±åº¦å­¦ä¹ ï¼Ÿ"ï¼ˆå®šä¹‰å‹é—®é¢˜ï¼‰

é…ç½®1ï¼ˆç²¾ç¡®ä¼˜å…ˆï¼‰ï¼šchunk_size=128, overlap=0
æ£€ç´¢ç»“æœï¼š
- Chunk 1: "æ·±åº¦å­¦ä¹ æ˜¯æœºå™¨å­¦ä¹ çš„ä¸€ä¸ªåˆ†æ”¯"ï¼ˆç›¸ä¼¼åº¦0.92ï¼‰
- Chunk 2: "æ·±åº¦å­¦ä¹ ä½¿ç”¨å¤šå±‚ç¥ç»ç½‘ç»œ"ï¼ˆç›¸ä¼¼åº¦0.89ï¼‰
- Chunk 3: "æ·±åº¦å­¦ä¹ çš„æ ¸å¿ƒæ˜¯åå‘ä¼ æ’­ç®—æ³•"ï¼ˆç›¸ä¼¼åº¦0.85ï¼‰

LLMå›ç­”ï¼šå‡†ç¡®å®šä¹‰ + æ ¸å¿ƒç‰¹å¾ âœ“

é…ç½®2ï¼ˆä¸Šä¸‹æ–‡ä¼˜å…ˆï¼‰ï¼šchunk_size=512, overlap=100
æ£€ç´¢ç»“æœï¼š
- Chunk 1: åŒ…å«å®šä¹‰ + å†å²èƒŒæ™¯ + åº”ç”¨åœºæ™¯ï¼ˆç›¸ä¼¼åº¦0.78ï¼‰
- Chunk 2: åŒ…å«å®šä¹‰ + æŠ€æœ¯ç»†èŠ‚ + å¯¹æ¯”åˆ†æï¼ˆç›¸ä¼¼åº¦0.76ï¼‰

LLMå›ç­”ï¼šè¯¦ç»†ä½†å†—é•¿ï¼Œå¯èƒ½åç¦»é‡ç‚¹ â–³
```

---

#### ç­–ç•¥2ï¼šä¸Šä¸‹æ–‡ä¼˜å…ˆï¼ˆContext-Firstï¼‰

**é€‚ç”¨åœºæ™¯**ï¼š
- âœ“ å¤æ‚æ¨ç†å‹é—®ç­”ï¼ˆ"æ·±åº¦å­¦ä¹ ä¸ä¼ ç»Ÿæœºå™¨å­¦ä¹ çš„æœ¬è´¨åŒºåˆ«æ˜¯ä»€ä¹ˆï¼Ÿä¸ºä»€ä¹ˆæ·±åº¦å­¦ä¹ åœ¨å›¾åƒè¯†åˆ«é¢†åŸŸæ›´æœ‰æ•ˆï¼Ÿ"ï¼‰
- âœ“ æ–‡å­¦åˆ†æã€å†å²è§£è¯»
- âœ“ éœ€è¦å‰å› åæœçš„åœºæ™¯
- âœ“ å¤šè½®å¯¹è¯ç³»ç»Ÿ

**æ¨èé…ç½®**ï¼š
```python
# é…ç½®æ–¹æ¡ˆ
chunk_size = 400          # å¤§chunkï¼ŒåŒ…å«å®Œæ•´æ®µè½
chunk_overlap = 80        # ä¸­ç­‰é‡å ï¼ˆ20%ï¼‰
similarity_top_k = 5      # å¤šå¬å›

# ä½¿ç”¨SentenceWindowNodeParser
base_splitter = SentenceSplitter(chunk_size=512, chunk_overlap=50)
base_nodes = base_splitter.get_nodes_from_documents(documents)

window_splitter = SentenceWindowNodeParser(
    window_size=3,        # å‰åå„3å¥
    window_metadata_key="window"
)
nodes = window_splitter.build_window_nodes_from_documents(base_nodes)

# æŸ¥è¯¢æ—¶ä½¿ç”¨çª—å£ä¸Šä¸‹æ–‡
query_engine = index.as_query_engine(
    similarity_top_k=5,
    node_postprocessors=[
        MetadataReplacementPostProcessor(target_metadata_key="window")
    ]
)
```

**ä¼˜åŠ¿**ï¼š
- âœ… èƒ½å›ç­”å¤æ‚ã€å¼€æ”¾æ€§é—®é¢˜
- âœ… æ”¯æŒæ¨ç†å’Œå¯¹æ¯”åˆ†æ
- âœ… ä¸Šä¸‹æ–‡è¿è´¯ï¼ŒLLMç”Ÿæˆè´¨é‡é«˜

**åŠ£åŠ¿**ï¼š
- âŒ æ£€ç´¢å¯èƒ½ä¸ç²¾ç¡®ï¼ˆå¤§chunkç›¸ä¼¼åº¦åä½ï¼‰
- âŒ è®¡ç®—å’Œå­˜å‚¨æˆæœ¬é«˜
- âŒ å¯èƒ½å¼•å…¥å™ªå£°

---

#### ç­–ç•¥3ï¼šæ··åˆç­–ç•¥ï¼ˆHybrid Strategyï¼‰â­ **æ¨è**

**æ ¸å¿ƒæ€æƒ³**ï¼šåŒæ—¶ä½¿ç”¨å¤šç§chunkç­–ç•¥ï¼Œæ£€ç´¢æ—¶èåˆç»“æœ

**å®ç°æ–¹æ¡ˆ**ï¼š

```python
from llama_index.core import VectorStoreIndex
from llama_index.core.node_parser import SentenceSplitter
from llama_index.core.retrievers import VectorIndexRetriever
from llama_index.core.query_engine import RetrieverQueryEngine

# æ–¹æ¡ˆAï¼šå¤šç²’åº¦ç´¢å¼•
class MultiGranularityRAG:
    def __init__(self, documents):
        # å°chunkç´¢å¼•ï¼ˆç²¾ç¡®æ£€ç´¢ï¼‰
        small_splitter = SentenceSplitter(chunk_size=200, chunk_overlap=20)
        small_nodes = small_splitter.get_nodes_from_documents(documents)
        self.small_index = VectorStoreIndex(small_nodes)
        
        # å¤§chunkç´¢å¼•ï¼ˆä¸Šä¸‹æ–‡ä¸°å¯Œï¼‰
        large_splitter = SentenceSplitter(chunk_size=500, chunk_overlap=100)
        large_nodes = large_splitter.get_nodes_from_documents(documents)
        self.large_index = VectorStoreIndex(large_nodes)
    
    def query(self, query_str, query_type='balanced'):
        if query_type == 'precise':
            # ç²¾ç¡®æŸ¥è¯¢ï¼šåªç”¨å°chunk
            retriever = self.small_index.as_retriever(similarity_top_k=3)
        elif query_type == 'contextual':
            # ä¸Šä¸‹æ–‡æŸ¥è¯¢ï¼šåªç”¨å¤§chunk
            retriever = self.large_index.as_retriever(similarity_top_k=3)
        else:
            # å¹³è¡¡æŸ¥è¯¢ï¼šèåˆä¸¤è€…
            small_retriever = self.small_index.as_retriever(similarity_top_k=2)
            large_retriever = self.large_index.as_retriever(similarity_top_k=2)
            # åˆå¹¶ç»“æœï¼ˆéœ€è¦è‡ªå®šä¹‰èåˆé€»è¾‘ï¼‰
            ...
        
        query_engine = RetrieverQueryEngine(retriever)
        return query_engine.query(query_str)

# ä½¿ç”¨ç¤ºä¾‹
rag = MultiGranularityRAG(documents)

# ç®€çŸ­é—®ç­”ç”¨ç²¾ç¡®æ¨¡å¼
answer1 = rag.query("ä»€ä¹ˆæ˜¯CNNï¼Ÿ", query_type='precise')

# å¤æ‚åˆ†æç”¨ä¸Šä¸‹æ–‡æ¨¡å¼
answer2 = rag.query("CNNä¸RNNçš„åŒºåˆ«åŠå„è‡ªé€‚ç”¨åœºæ™¯", query_type='contextual')

# é»˜è®¤å¹³è¡¡æ¨¡å¼
answer3 = rag.query("æ·±åº¦å­¦ä¹ çš„å‘å±•å†å²", query_type='balanced')
```

**æ–¹æ¡ˆBï¼šå¥å­çª—å£ç­–ç•¥ï¼ˆæœ¬å®éªŒé‡‡ç”¨ï¼‰**

```python
# è¿™æ˜¯æœ€ä¼˜é›…çš„æ··åˆæ–¹æ¡ˆ
# åŸç†ï¼šæ£€ç´¢æ—¶ç”¨å°chunkï¼ˆç²¾ç¡®ï¼‰ï¼Œè¿”å›æ—¶ç”¨çª—å£ä¸Šä¸‹æ–‡ï¼ˆä¸°å¯Œï¼‰

# æ­¥éª¤1ï¼šåˆ›å»ºåŸºç¡€å°chunk
base_splitter = SentenceSplitter(chunk_size=256, chunk_overlap=40)
base_nodes = base_splitter.get_nodes_from_documents(documents)

# æ­¥éª¤2ï¼šä¸ºæ¯ä¸ªchunké™„åŠ çª—å£ä¸Šä¸‹æ–‡
window_splitter = SentenceWindowNodeParser(
    window_size=3,  # å‰åå„3å¥
    window_metadata_key="window",
    original_text_metadata_key="original_text"
)
window_nodes = window_splitter.build_window_nodes_from_documents(base_nodes)

# æ­¥éª¤3ï¼šåˆ›å»ºç´¢å¼•ï¼ˆå‘é‡ä»åŸºäºå°chunkï¼‰
index = VectorStoreIndex(window_nodes)

# æ­¥éª¤4ï¼šæŸ¥è¯¢æ—¶æ›¿æ¢ä¸ºçª—å£ä¸Šä¸‹æ–‡
query_engine = index.as_query_engine(
    similarity_top_k=5,
    node_postprocessors=[
        MetadataReplacementPostProcessor(target_metadata_key="window")
    ]
)

# æ•ˆæœï¼š
# - æ£€ç´¢é˜¶æ®µï¼šä½¿ç”¨256å­—ç¬¦çš„å°chunkè¿›è¡Œå‘é‡åŒ¹é…ï¼ˆç²¾ç¡®ï¼‰âœ“
# - ç”Ÿæˆé˜¶æ®µï¼šLLMçœ‹åˆ°çš„æ˜¯çº¦700å­—ç¬¦çš„çª—å£ä¸Šä¸‹æ–‡ï¼ˆä¸°å¯Œï¼‰âœ“
```

**æ··åˆç­–ç•¥çš„ä¼˜åŠ¿**ï¼š
- âœ… å…¼é¡¾ç²¾ç¡®æ€§å’Œå®Œæ•´æ€§
- âœ… æ ¹æ®æŸ¥è¯¢ç±»å‹åŠ¨æ€è°ƒæ•´
- âœ… æ›´é²æ£’ï¼Œé€‚åº”å¤šç§é—®é¢˜

---

### 3.3 æŠ€æœ¯å®ç°ï¼šæƒè¡¡å‚æ•°è°ƒä¼˜è¡¨ ğŸ“Š

| ç›®æ ‡ä¾§é‡ | chunk_size | chunk_overlap | window_size | similarity_top_k | é¢„æœŸæ•ˆæœ |
|---------|-----------|--------------|-------------|-----------------|---------|
| **æè‡´ç²¾ç¡®** | 150 | 15 (10%) | N/A | 2-3 | å¿«é€Ÿå®šä½ï¼Œç®€çŸ­å›ç­” |
| **ç²¾ç¡®ä¼˜å…ˆ** | 200-256 | 20-40 (10-15%) | 1 | 3-4 | å‡†ç¡®æ€§é«˜ï¼Œæ•ˆç‡å¥½ |
| **å¹³è¡¡æ¨¡å¼** | 256-300 | 40-60 (15-20%) | 2-3 | 4-5 | **é€šç”¨æ¨è** âœ… |
| **ä¸Šä¸‹æ–‡ä¼˜å…ˆ** | 400-512 | 80-100 (20%) | 5 | 5-7 | å¤æ‚æ¨ç†ï¼Œè¯¦ç»†å›ç­” |
| **æè‡´ä¸Šä¸‹æ–‡** | 512+ | 100+ (20-30%) | 7-10 | 7-10 | æ·±åº¦åˆ†æï¼Œä½†å™ªå£°å¤š |

---

### 3.4 å†³ç­–æ ‘ï¼šé€‰æ‹©åˆé€‚çš„æƒè¡¡ç‚¹ ğŸŒ³

```
å¼€å§‹
  â”‚
  â”œâ”€ é—®é¢˜ç±»å‹æ˜¯ä»€ä¹ˆï¼Ÿ
  â”‚   â”œâ”€ ç®€å•äº‹å®æŸ¥è¯¢ â†’ [ç²¾ç¡®ä¼˜å…ˆ] chunk_size=200, overlap=20
  â”‚   â”œâ”€ å®šä¹‰/æ¦‚å¿µè§£é‡Š â†’ [å¹³è¡¡æ¨¡å¼] chunk_size=256, overlap=40, window_size=2
  â”‚   â”œâ”€ å¯¹æ¯”åˆ†æ â†’ [ä¸Šä¸‹æ–‡ä¼˜å…ˆ] chunk_size=400, overlap=80, window_size=5
  â”‚   â””â”€ å¼€æ”¾æ€§è®¨è®º â†’ [æè‡´ä¸Šä¸‹æ–‡] chunk_size=512, window_size=7
  â”‚
  â”œâ”€ æ–‡æ¡£é•¿åº¦ï¼Ÿ
  â”‚   â”œâ”€ çŸ­æ–‡æ¡£(<5000å­—) â†’ chunk_sizeåå¤§(400+)ï¼Œå‡å°‘ç¢ç‰‡åŒ–
  â”‚   â”œâ”€ ä¸­ç­‰æ–‡æ¡£(5000-50000å­—) â†’ chunk_size=256-300 âœ…
  â”‚   â””â”€ é•¿æ–‡æ¡£(>50000å­—) â†’ chunk_sizeåå°(200)ï¼Œæé«˜æ£€ç´¢ç²¾åº¦
  â”‚
  â”œâ”€ å“åº”æ—¶é—´è¦æ±‚ï¼Ÿ
  â”‚   â”œâ”€ å®æ—¶(<1ç§’) â†’ å°chunk + ä½overlap + å°top_k
  â”‚   â””â”€ å¯å®¹å¿å»¶è¿Ÿ â†’ å¯ä»¥ç”¨çª—å£ç­–ç•¥
  â”‚
  â”œâ”€ æˆæœ¬é¢„ç®—ï¼Ÿ
  â”‚   â”œâ”€ é¢„ç®—ç´§å¼  â†’ é¿å…å¤§overlapå’Œå¤§çª—å£
  â”‚   â””â”€ é¢„ç®—å……è¶³ â†’ å¤šç´¢å¼•æ··åˆç­–ç•¥
  â”‚
  â””â”€ ç”¨æˆ·å®¹å¿åº¦ï¼Ÿ
      â”œâ”€ è¦æ±‚é«˜ç²¾åº¦ â†’ [ç²¾ç¡®ä¼˜å…ˆ]
      â””â”€ æ¥å—ä¸€å®šå™ªå£°ï¼Œè¿½æ±‚å®Œæ•´æ€§ â†’ [ä¸Šä¸‹æ–‡ä¼˜å…ˆ]
```

---

### 3.5 å®éªŒéªŒè¯ï¼šä¸åŒæƒè¡¡ç­–ç•¥çš„å®é™…æ•ˆæœ

åŸºäºæœ¬æ¬¡å®éªŒçš„15ä¸ªé…ç½®ï¼Œæˆ‘ä»¬å¯ä»¥æ€»ç»“ï¼š

#### æœ€ä¼˜é…ç½®ç»„åˆï¼ˆä¸­æ–‡é—®ç­”ç³»ç»Ÿï¼‰

**ğŸ† æ¨èé…ç½®ï¼šå¹³è¡¡æ¨¡å¼**
```python
# æ–¹æ³•1ï¼šå¥å­åˆ‡ç‰‡ + é€‚åº¦é‡å 
splitter = SentenceSplitter(
    chunk_size=256,
    chunk_overlap=50  # 19.5%
)
# é¢„æœŸï¼š35ä¸ªèŠ‚ç‚¹ï¼Œå…¼é¡¾ç²¾ç¡®å’Œå®Œæ•´

# æ–¹æ³•2ï¼šå¥å­çª—å£ï¼ˆæœ€ä½³æ–¹æ¡ˆï¼‰â­
base_splitter = SentenceSplitter(chunk_size=256, chunk_overlap=40)
base_nodes = base_splitter.get_nodes_from_documents(documents)

window_splitter = SentenceWindowNodeParser(
    window_size=3,  # å‰åå„3å¥ï¼Œçº¦7å¥è¯çš„ä¸Šä¸‹æ–‡
    window_metadata_key="window"
)
nodes = window_splitter.build_window_nodes_from_documents(base_nodes)

# æŸ¥è¯¢é…ç½®
query_engine = index.as_query_engine(
    similarity_top_k=5,
    node_postprocessors=[
        MetadataReplacementPostProcessor(target_metadata_key="window")
    ]
)

# æ•ˆæœï¼š
# âœ“ æ£€ç´¢ç²¾å‡†åº¦ï¼šåŸºäº256å­—ç¬¦å°chunk
# âœ“ ä¸Šä¸‹æ–‡ä¸°å¯Œåº¦ï¼šåŒ…å«çº¦700å­—ç¬¦çª—å£
# âœ“ æ€§èƒ½å¼€é”€ï¼š31ä¸ªèŠ‚ç‚¹ï¼Œå¯æ¥å—
# âœ“ é€‚ç”¨90%çš„é€šç”¨é—®ç­”åœºæ™¯
```

---

### 3.6 åŠ¨æ€è‡ªé€‚åº”ç­–ç•¥ï¼ˆè¿›é˜¶ï¼‰ğŸš€

**ç†æƒ³æ–¹æ¡ˆ**ï¼šæ ¹æ®æŸ¥è¯¢ç‰¹å¾åŠ¨æ€è°ƒæ•´ç­–ç•¥

```python
import re
from typing import Literal

QueryType = Literal['factual', 'analytical', 'exploratory']

def detect_query_type(query: str) -> QueryType:
    """
    æ ¹æ®æŸ¥è¯¢æ–‡æœ¬åˆ¤æ–­é—®é¢˜ç±»å‹
    
    è¿”å›ï¼š
        'factual': äº‹å®æŸ¥è¯¢ï¼ˆä»€ä¹ˆæ˜¯ã€å®šä¹‰ã€ä¸¾ä¾‹ï¼‰
        'analytical': åˆ†æå‹ï¼ˆä¸ºä»€ä¹ˆã€å¦‚ä½•ã€æ¯”è¾ƒï¼‰
        'exploratory': æ¢ç´¢å‹ï¼ˆè®¨è®ºã€å½±å“ã€è¶‹åŠ¿ï¼‰
    """
    # äº‹å®æŸ¥è¯¢å…³é”®è¯
    factual_patterns = [
        r'ä»€ä¹ˆæ˜¯', r'å®šä¹‰', r'ä¸¾ä¾‹', r'åˆ—ä¸¾',
        r'è¯­æ³•', r'å‚æ•°', r'ç”¨æ³•'
    ]
    
    # åˆ†ææŸ¥è¯¢å…³é”®è¯
    analytical_patterns = [
        r'ä¸ºä»€ä¹ˆ', r'å¦‚ä½•', r'æ€ä¹ˆ', r'åŒºåˆ«',
        r'ä¼˜ç¼ºç‚¹', r'å¯¹æ¯”', r'åŸç†'
    ]
    
    # æ¢ç´¢æŸ¥è¯¢å…³é”®è¯
    exploratory_patterns = [
        r'è®¨è®º', r'åˆ†æ', r'å½±å“', r'è¶‹åŠ¿',
        r'å‘å±•', r'æœªæ¥', r'çœ‹æ³•'
    ]
    
    if any(re.search(p, query) for p in factual_patterns):
        return 'factual'
    elif any(re.search(p, query) for p in analytical_patterns):
        return 'analytical'
    elif any(re.search(p, query) for p in exploratory_patterns):
        return 'exploratory'
    else:
        return 'factual'  # é»˜è®¤

class AdaptiveRAG:
    def __init__(self, documents):
        # é¢„å…ˆåˆ›å»ºä¸‰ç§ç²’åº¦çš„ç´¢å¼•
        self.indexes = {
            'small': self._create_index(documents, chunk_size=200, overlap=20),
            'medium': self._create_index(documents, chunk_size=300, overlap=50),
            'large': self._create_index(documents, chunk_size=500, overlap=100)
        }
    
    def query(self, query_str: str):
        # æ ¹æ®æŸ¥è¯¢ç±»å‹é€‰æ‹©ç´¢å¼•
        query_type = detect_query_type(query_str)
        
        if query_type == 'factual':
            index = self.indexes['small']
            top_k = 3
        elif query_type == 'analytical':
            index = self.indexes['medium']
            top_k = 5
        else:  # exploratory
            index = self.indexes['large']
            top_k = 7
        
        query_engine = index.as_query_engine(similarity_top_k=top_k)
        return query_engine.query(query_str)

# ä½¿ç”¨ç¤ºä¾‹
rag = AdaptiveRAG(documents)

# è‡ªåŠ¨æ£€æµ‹ä¸ºfactualï¼Œä½¿ç”¨å°chunk
answer1 = rag.query("ä»€ä¹ˆæ˜¯å·ç§¯ç¥ç»ç½‘ç»œï¼Ÿ")

# è‡ªåŠ¨æ£€æµ‹ä¸ºanalyticalï¼Œä½¿ç”¨ä¸­chunk
answer2 = rag.query("CNNå’ŒRNNçš„åŒºåˆ«æ˜¯ä»€ä¹ˆï¼Ÿ")

# è‡ªåŠ¨æ£€æµ‹ä¸ºexploratoryï¼Œä½¿ç”¨å¤§chunk
answer3 = rag.query("è®¨è®ºæ·±åº¦å­¦ä¹ å¯¹äººå·¥æ™ºèƒ½å‘å±•çš„å½±å“")
```

---

### 3.7 æ€»ç»“ï¼šæƒè¡¡çš„è‰ºæœ¯ ğŸ¨

**æ ¸å¿ƒåŸåˆ™**ï¼š
1. **æ²¡æœ‰é“¶å¼¹**ï¼šä¸å­˜åœ¨é€‚ç”¨æ‰€æœ‰åœºæ™¯çš„å®Œç¾é…ç½®
2. **åœºæ™¯é©±åŠ¨**ï¼šæ ¹æ®åº”ç”¨éœ€æ±‚é€‰æ‹©ä¾§é‡ç‚¹
3. **è¿­ä»£ä¼˜åŒ–**ï¼šé€šè¿‡A/Bæµ‹è¯•ä¸æ–­è°ƒæ•´å‚æ•°
4. **æ··åˆç­–ç•¥**ï¼šåœ¨å¯èƒ½çš„æƒ…å†µä¸‹ï¼ŒåŒæ—¶æ„å»ºå¤šç§ç²’åº¦ç´¢å¼•

**å¿«é€Ÿå†³ç­–æŒ‡å—**ï¼š
```
å¦‚æœä½ çš„åº”ç”¨æ˜¯...
  â†’ å®¢æœé—®ç­”æœºå™¨äºº â†’ [ç²¾ç¡®ä¼˜å…ˆ] chunk_size=200, overlap=20
  â†’ çŸ¥è¯†åº“æ£€ç´¢ç³»ç»Ÿ â†’ [å¹³è¡¡æ¨¡å¼] chunk_size=256, overlap=40, window_size=2
  â†’ ç ”ç©¶åŠ©æ‰‹/åˆ†æå·¥å…· â†’ [ä¸Šä¸‹æ–‡ä¼˜å…ˆ] chunk_size=400, window_size=5
  â†’ ä¸ç¡®å®š â†’ [ä½¿ç”¨å¥å­çª—å£ç­–ç•¥] æœ€å®‰å…¨çš„é€‰æ‹© âœ…
```

**æœ¬å®éªŒçš„å…³é”®å‘ç°**ï¼š
- âœ… **å¥å­çª—å£ç­–ç•¥**ï¼ˆSentenceWindowNodeParserï¼‰æ˜¯æœ€ä¼˜é›…çš„è§£å†³æ–¹æ¡ˆ
- âœ… chunk_size=256å­—ç¬¦ + overlap=40-50å­—ç¬¦ é€‚åˆ90%çš„ä¸­æ–‡åœºæ™¯
- âœ… window_size=2-3 å¯ä»¥åœ¨ä¸æ˜¾è‘—å¢åŠ æˆæœ¬çš„æƒ…å†µä¸‹æå‡ä¸Šä¸‹æ–‡è´¨é‡
- âš ï¸ è¿‡åº¦ä¼˜åŒ–æŸä¸€æ–¹å‘ï¼ˆè¿‡å°æˆ–è¿‡å¤§chunkï¼‰éƒ½ä¼šæŸå®³æ•´ä½“æ•ˆæœ

---

## å››ã€å®éªŒæ€»ç»“ä¸æœ€ä½³å®è·µ

### 4.1 å…³é”®å‘ç° ğŸ”

1. **chunk_sizeæ˜¯æœ€å…³é”®å‚æ•°**
   - å»ºè®®èŒƒå›´ï¼š200-300å­—ç¬¦ï¼ˆä¸­æ–‡ï¼‰
   - æœ€ä¼˜å€¼ï¼š256å­—ç¬¦ï¼ˆåœ¨12Kå­—ç¬¦æµ‹è¯•é›†ä¸Šï¼‰

2. **chunk_overlapçš„é»„é‡‘æ¯”ä¾‹ï¼š15-25%**
   - è¿‡ä½ï¼šä¿¡æ¯æ–­è£‚
   - è¿‡é«˜ï¼šå­˜å‚¨æµªè´¹ã€æ£€ç´¢å™ªå£°
   - æ¨èï¼šchunk_size=256æ—¶ï¼Œoverlap=40-50

3. **å¥å­çª—å£ç­–ç•¥æ˜¯æœ€ä½³å¹³è¡¡æ–¹æ¡ˆ**
   - æ£€ç´¢ç²¾ç¡®ï¼ˆåŸºäºå°chunkå‘é‡ï¼‰
   - ä¸Šä¸‹æ–‡ä¸°å¯Œï¼ˆè¿”å›çª—å£å†…å®¹ï¼‰
   - å®ç°å¤æ‚åº¦å¯æ¥å—

4. **ä¸åŒåœºæ™¯éœ€è¦ä¸åŒç­–ç•¥**
   - ç®€å•é—®ç­”ï¼šç²¾ç¡®ä¼˜å…ˆ
   - å¤æ‚æ¨ç†ï¼šä¸Šä¸‹æ–‡ä¼˜å…ˆ
   - é€šç”¨ç³»ç»Ÿï¼šæ··åˆç­–ç•¥

### 4.2 ç”Ÿäº§ç¯å¢ƒå»ºè®®é…ç½® âš™ï¸

```python
# æ¨èé…ç½®ï¼šé€‚ç”¨äºå¤§å¤šæ•°ä¸­æ–‡RAGåº”ç”¨
from llama_index.core import Settings
from llama_index.core.node_parser import SentenceSplitter, SentenceWindowNodeParser
from llama_index.core.postprocessor import MetadataReplacementPostProcessor

# å…¨å±€è®¾ç½®
Settings.text_splitter = SentenceSplitter(
    chunk_size=256,      # æ ¸å¿ƒå‚æ•°
    chunk_overlap=50     # çº¦20%é‡å 
)

# åˆ›å»ºå¥å­çª—å£èŠ‚ç‚¹
base_splitter = SentenceSplitter(chunk_size=256, chunk_overlap=50)
base_nodes = base_splitter.get_nodes_from_documents(documents)

window_splitter = SentenceWindowNodeParser(
    window_size=3,       # å‰åå„3å¥
    window_metadata_key="window",
    original_text_metadata_key="original_text"
)
nodes = window_splitter.build_window_nodes_from_documents(base_nodes)

# åˆ›å»ºç´¢å¼•
index = VectorStoreIndex(nodes)

# é…ç½®æŸ¥è¯¢å¼•æ“
query_engine = index.as_query_engine(
    similarity_top_k=5,  # å¬å›5ä¸ªèŠ‚ç‚¹
    node_postprocessors=[
        MetadataReplacementPostProcessor(target_metadata_key="window")
    ]
)

# ä½¿ç”¨
response = query_engine.query("ä½ çš„é—®é¢˜")
```

### 4.3 é¿å‘æŒ‡å— âš ï¸

1. **ä¸è¦ç›´æ¥å¯¹æ–‡æ¡£ä½¿ç”¨SentenceWindowNodeParser**
   - âŒ `nodes = splitter.get_nodes_from_documents(documents)`
   - âœ… å…ˆåˆ†å‰²ï¼Œå†æ„å»ºçª—å£

2. **æ³¨æ„Embeddingæ¨¡å‹çš„é•¿åº¦é™åˆ¶**
   - DashScope: 2048 tokens/text
   - ç¡®ä¿chunk_sizeä¸è¶…è¿‡é™åˆ¶ï¼ˆç•™20%ä½™é‡ï¼‰

3. **Tokenåˆ‡ç‰‡ vs å­—ç¬¦åˆ‡ç‰‡**
   - ä¸­æ–‡ï¼š1å­—ç¬¦ â‰ˆ 0.5-0.7 tokens
   - 256å­—ç¬¦ â‰ˆ 128-179 tokens
   - é€‰æ‹©æ—¶éœ€è¦æ¢ç®—

4. **å­˜å‚¨æˆæœ¬è®¡ç®—**
   - è€ƒè™‘é‡å å¸¦æ¥çš„å­˜å‚¨è†¨èƒ€
   - overlap=50æ—¶ï¼Œå®é™…å­˜å‚¨çº¦ä¸ºæ–‡æœ¬çš„1.2-1.3å€

### 4.4 æœªæ¥ä¼˜åŒ–æ–¹å‘ ğŸš€

1. **è¯­ä¹‰è¾¹ç•Œåˆ‡åˆ†**
   - ä¸æŒ‰å›ºå®šé•¿åº¦ï¼Œè€Œæ˜¯æŒ‰ä¸»é¢˜/æ®µè½åˆ‡åˆ†
   - åˆ©ç”¨LLMè¿›è¡Œæ™ºèƒ½åˆ†å‰²

2. **åŠ¨æ€chunk_size**
   - æ ¹æ®æ–‡æ¡£å¯†åº¦è‡ªé€‚åº”è°ƒæ•´
   - æŠ€æœ¯æ–‡æ¡£ç”¨å°chunkï¼Œå™äº‹æ–‡æ¡£ç”¨å¤§chunk

3. **å±‚æ¬¡åŒ–ç´¢å¼•**
   - æ„å»ºæ–‡æ¡£â†’ç« èŠ‚â†’æ®µè½â†’å¥å­çš„å¤šçº§ç´¢å¼•
   - å…ˆç²—ç²’åº¦æ£€ç´¢ï¼Œå†ç»†ç²’åº¦å®šä½

4. **æŸ¥è¯¢é‡å†™**
   - å¤æ‚æŸ¥è¯¢æ‹†åˆ†ä¸ºå¤šä¸ªå­æŸ¥è¯¢
   - ä¸åŒå­æŸ¥è¯¢ä½¿ç”¨ä¸åŒæ£€ç´¢ç­–ç•¥

---

## äº”ã€å®éªŒæŠ€æœ¯ç»†èŠ‚

### 5.1 æµ‹è¯•ç¯å¢ƒ

- **æ¡†æ¶**: LlamaIndex 0.x
- **Embedding**: DashScope TEXT_EMBEDDING_V3
- **LLM**: qwen-plus
- **æ–‡æ¡£**: 3ä¸ªä¸­æ–‡æ–‡æœ¬ï¼ˆAI/ML/NLPä¸»é¢˜ï¼Œå…±12,776å­—ç¬¦ï¼‰
- **æŸ¥è¯¢**: "ä»€ä¹ˆæ˜¯æ·±åº¦å­¦ä¹ ï¼Ÿå®ƒä¸æœºå™¨å­¦ä¹ æœ‰ä»€ä¹ˆå…³ç³»ï¼Ÿ"

### 5.2 æµ‹è¯•é…ç½®çŸ©é˜µ

| æ–¹æ³• | é…ç½®æ•° | å‚æ•°èŒƒå›´ |
|------|--------|---------|
| SentenceSplitter | 5 | chunk_size: 128-512, overlap: 0-100 |
| TokenTextSplitter | 5 | chunk_size: 128-512 tokens, overlap: 0-50 tokens |
| SentenceWindowNodeParser | 5 | window_size: 1-10å¥ |

### 5.3 è¯„ä¼°æŒ‡æ ‡ï¼ˆç†æƒ³çŠ¶æ€ï¼‰

- æŸ¥è¯¢å“åº”æ—¶é—´
- æ£€ç´¢ç›¸ä¼¼åº¦å¾—åˆ†
- ç”Ÿæˆç­”æ¡ˆè´¨é‡ï¼ˆäººå·¥è¯„ä¼°ï¼‰
- èŠ‚ç‚¹æ•°é‡å’Œå¤§å°åˆ†å¸ƒ

### 5.4 ä¿®å¤æˆæœ

**é—®é¢˜**: SentenceWindowNodeParserç”Ÿæˆè¶…å¤§èŠ‚ç‚¹å¯¼è‡´embeddingå¤±è´¥

**è§£å†³**: é‡‡ç”¨ä¸¤æ­¥æ³•
1. å…ˆç”¨SentenceSplitteråˆ›å»ºåŸºç¡€èŠ‚ç‚¹
2. å†ç”¨build_window_nodes_from_documentsæ„å»ºçª—å£

**æ•ˆæœ**:
- ä¿®å¤å‰: 3ä¸ªèŠ‚ç‚¹ï¼ˆ3007-5520å­—ç¬¦ï¼‰âŒ
- ä¿®å¤å: 31ä¸ªèŠ‚ç‚¹ï¼ˆ300-500å­—ç¬¦ï¼‰âœ…

---

## å‚è€ƒæ–‡çŒ®

1. LlamaIndexå®˜æ–¹æ–‡æ¡£: https://docs.llamaindex.ai/
2. DashScope APIæ–‡æ¡£: https://help.aliyun.com/zh/dashscope/
3. ç›¸å…³ä»£ç :
   - `main.py`: å®Œæ•´æµ‹è¯•ä»£ç 
   - `SENTENCE_WINDOW_FIX.md`: çª—å£åˆ‡ç‰‡ä¿®å¤è¯´æ˜
   - `test_sentence_window.py`: ç‹¬ç«‹æµ‹è¯•è„šæœ¬

---

**æŠ¥å‘Šæ—¥æœŸ**: 2025å¹´11æœˆ18æ—¥  
**å®éªŒçŠ¶æ€**: æ ¸å¿ƒåŠŸèƒ½éªŒè¯å®Œæˆï¼ŒLLMå“åº”è¯„ä¼°å› ç½‘ç»œé—®é¢˜ä¸­æ–­ä½†ä¸å½±å“ç»“è®º  
**ä¸‹ä¸€æ­¥**: åœ¨ç¨³å®šç½‘ç»œç¯å¢ƒä¸‹å®Œæ•´æµ‹è¯•15ä¸ªé…ç½®ï¼Œç”Ÿæˆå®šé‡è¯„åˆ†å¯¹æ¯”
